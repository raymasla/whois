<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª°æ˜¯è‡¥åº• ç°¡æ˜“ç‰ˆ</title>
    <style>
        :root {
            /* æš—é»‘æ¨¡å¼é…è‰²è®Šæ•¸ */
            --primary: #3498db;
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f1c40f;
            --bg: #121212;        /* æ·±è‰²èƒŒæ™¯ */
            --card: #1e1e1e;      /* å¡ç‰‡èƒŒæ™¯ */
            --text: #e0e0e0;      /* ä¸»è¦æ–‡å­— */
            --text-muted: #a0a0a0;
            --border: #333333;
            --input-bg: #2d2d2d;
            --hover: #2c3e50;
            --chat-bg: #1a1a1a;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            /* è®“å®¹å™¨é«˜åº¦é©æ‡‰å…§å®¹ï¼Œä½†åœ¨èŠå¤©å®¤å¾ˆé•·æ™‚ä¸è¶…éè¦–çª—å¤ªå¤š */
            max-height: 95vh;
            overflow-y: auto; 
        }
        h1, h2, h3 { text-align: center; color: var(--text); margin-top: 0;}
        .screen { display: none; }
        .active { display: block; }
        
        button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
            font-weight: bold;
        }
        button:hover { filter: brightness(1.1); }
        button:disabled { background: #555; cursor: not-allowed; color: #888; }
        button.danger { background: var(--danger); }
        button.secondary { background: #555; }
        button.success { background: var(--success); }
        button.small-btn { width: auto; padding: 5px 10px; font-size: 14px; margin: 0; }
        
        input, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        .room-item {
            background: #252525;
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-card {
            background: #252525;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }
        .player-card.is-me { border-color: var(--primary); background: #1a2634; }
        .player-card.dead { opacity: 0.5; background: #1a1a1a; }
        .player-card.dead strong { text-decoration: line-through; color: var(--danger); }

        .word-display {
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            padding: 25px;
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            border-radius: 12px;
            margin: 20px 0;
            color: #f1c40f;
            border: 1px solid #444;
            user-select: none;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .tag {
            font-size: 11px;
            padding: 3px 6px;
            border-radius: 4px;
            background: #444;
            color: #ddd;
            margin-left: 5px;
            vertical-align: middle;
        }
        .tag.host { background: #f39c12; color: #000; }
        .tag.vote-count { background: var(--danger); color: white; font-weight: bold; }

        .vote-btn {
            background: var(--danger);
            width: auto;
            padding: 6px 15px;
            font-size: 13px;
            margin: 0;
            border-radius: 20px;
        }

        /* è‡ªè¨‚è©èªå€åŸŸ */
        #custom-words-area {
            display: none;
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed #555;
            margin-top: 10px;
        }
        .custom-word-item {
            display: flex;
            justify-content: space-between;
            background: #333;
            padding: 5px 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 14px;
        }

        /* é®ç½©å±¤ (é¡¯ç¤ºçµæœç”¨) */
        #overlay-result {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
        }
        .result-title { font-size: 20px; color: #888; margin-bottom: 10px; }
        .result-name { font-size: 48px; font-weight: bold; color: var(--warning); margin: 10px 0; }
        .result-role { font-size: 32px; margin-bottom: 30px; }
        .result-role.spy { color: var(--danger); }
        .result-role.civilian { color: var(--success); }
        .result-status { 
            font-size: 24px; 
            border: 2px solid #555; 
            padding: 10px 40px; 
            border-radius: 50px; 
            margin-top: 30px; 
            display: inline-block;
            background: #111;
        }
        
        .admin-nuke-btn {
            background: transparent;
            border: 1px solid #555;
            color: #666;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 5px;
            border-radius: 4px;
        }
        .admin-nuke-btn:hover { background: var(--danger); color: white; border-color: var(--danger); }
        .admin-reveal {
            font-size: 11px;
            font-family: monospace;
            margin-top: 2px;
            background: #000;
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
        }

        /* èŠå¤©å®¤æ¨£å¼ */
        #chat-section {
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 15px;
            display: flex;
            flex-direction: column;
            height: 250px; /* å›ºå®šèŠå¤©å®¤é«˜åº¦ */
        }
        #chat-messages {
            flex: 1;
            background: var(--chat-bg);
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #333;
            font-size: 14px;
        }
        .chat-msg { margin-bottom: 6px; line-height: 1.4; word-break: break-all; }
        .chat-sender { color: var(--primary); font-weight: bold; margin-right: 5px; }
        .chat-input-wrapper { display: flex; gap: 8px; }
        .chat-input-wrapper input { margin: 0; flex: 1; }
        .chat-input-wrapper button { width: auto; margin: 0; padding: 0 20px; }

    </style>
</head>
<body>

<div id="overlay-result">
    <div class="result-title">æœ¬è¼ªæŠ•ç¥¨çµæœ</div>
    <div id="res-name" class="result-name">???</div>
    <div id="res-role" class="result-role">èº«åˆ†ï¼š<span id="res-role-text">---</span></div>
    
    <div id="res-game-status" class="result-status">éŠæˆ²ç¹¼çºŒ</div>

    <div style="margin-top: 50px; width: 100%; max-width: 300px;">
        <button onclick="app.closeOverlay()" class="success">ç¢ºèª</button>
    </div>
</div>

<div class="container">
    <div id="screen-login" class="screen active">
        <h1>ğŸ•µï¸ èª°æ˜¯è‡¥åº•</h1>
        <p style="text-align:center; color:var(--text-muted);">æ­¡è¿ï¼ è«‹è¼¸å…¥æš±ç¨±</p>
        <input type="text" id="username" placeholder="ä½ çš„æš±ç¨±">
        <button onclick="app.login()">é€²å…¥å¤§å»³</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h2>éŠæˆ²å¤§å»³</h2>
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <span>ç©å®¶: <span id="display-name" style="font-weight:bold; color:var(--primary);"></span></span>
            <button style="width:auto; margin:0;" onclick="app.showCreateRoom()">+ å‰µå»ºæˆ¿é–“</button>
        </div>
        <h3>æˆ¿é–“åˆ—è¡¨</h3>
        <div id="room-list">æ­£åœ¨è®€å–...</div>
    </div>

    <div id="screen-create" class="screen">
        <h2>å‰µå»ºæ–°æˆ¿é–“</h2>
        
        <label>æˆ¿é–“åç¨±</label>
        <input type="text" id="room-name-input" placeholder="ä¾‹å¦‚ï¼šå¯ç–‘çš„æˆ¿é–“" value="ä¾†ç•¶è‡¥åº•å›‰">

        <label>ç©å®¶ç¸½äººæ•¸ (3-10)</label>
        <select id="total-players">
            <option value="3">3äºº</option>
            <option value="4">4äºº</option>
            <option value="5">5äºº</option>
            <option value="6" selected>6äºº</option>
            <option value="7">7äºº</option>
            <option value="8">8äºº</option>
            <option value="9">9äºº</option>
            <option value="10">10äºº</option>
        </select>

        <label>è‡¥åº•äººæ•¸</label>
        <select id="spy-count">
            <option value="1">1äºº</option>
            <option value="2">2äºº</option>
            <option value="3">3äºº</option>
        </select>

        <div style="margin: 15px 0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="margin:0;">è©èªè¨­å®š</label>
                <button class="secondary small-btn" type="button" onclick="app.toggleCustomWords()">+ è‡ªè¨‚è©èª</button>
            </div>
            
            <div id="custom-words-area">
                <p style="margin:0 0 10px 0; font-size:12px; color:#aaa;">è¼¸å…¥å¾Œé»æ“Šã€Œæ–°å¢ã€ã€‚è‹¥æœ‰æ–°å¢ï¼ŒéŠæˆ²å°‡åªä½¿ç”¨æ­¤åˆ—è¡¨ã€‚</p>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="custom-civ" placeholder="å¹³æ°‘è© (å¦‚: è˜‹æœ)" style="margin:0;">
                    <input type="text" id="custom-spy" placeholder="è‡¥åº•è© (å¦‚: é¦™è•‰)" style="margin:0;">
                </div>
                <button type="button" class="success small-btn" style="width:100%; margin-top:5px;" onclick="app.addCustomWord()">æ–°å¢è©çµ„</button>
                
                <div id="custom-words-list" style="margin-top:10px; max-height:100px; overflow-y:auto;">
                    </div>
            </div>
        </div>

        <button onclick="app.createRoom()">ç¢ºèªå‰µå»º</button>
        <button class="secondary" onclick="app.switchScreen('screen-lobby')">å–æ¶ˆ</button>
    </div>

    <div id="screen-room" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <div style="display:flex; flex-direction:column;">
                <strong id="room-name-display" style="font-size: 18px; color: var(--primary);">æˆ¿é–“åç¨±</strong>
                <span id="room-id-display" style="font-size: 12px; color: #888;">æˆ¿è™Ÿ: ----</span>
            </div>
            <button class="secondary" style="width:auto; padding:6px 12px; font-size:14px; margin:0;" onclick="app.leaveRoom()">
                é›¢é–‹
            </button>
        </div>

        <div id="game-area" style="display:none;">
            <div class="word-display" id="word-card">
                <div style="font-size:14px; color:#888; font-weight:normal; margin-bottom:5px;">ä½ çš„è©èª</div>
                <span id="my-word">???</span>
            </div>
            <p style="text-align:center; font-size:12px; color:#666; margin-top:-10px;">
                é»æ“Šä¸Šæ–¹å¡ç‰‡å¯ éš±è—/é¡¯ç¤º
            </p>
        </div>

        <div style="display:flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px;">
            <h3 style="margin:0;">ç©å®¶åˆ—è¡¨ (<span id="player-count">0</span>/<span id="max-player-count">0</span>)</h3>
            <span id="status-badge" class="tag" style="font-size:14px; padding: 4px 8px;">ç­‰å¾…ä¸­</span>
        </div>
        
        <div id="player-list"></div>

        <div id="host-controls" style="display:none; border-top: 1px dashed #444; padding-top:15px; margin-top:20px;">
            <p style="text-align:center; color:#666; font-size:12px; margin:0 0 10px 0;">ğŸ‘‘ æˆ¿ä¸»æ§åˆ¶å€</p>
            
            <button onclick="app.startGame()" id="btn-start" class="success">é–‹å§‹éŠæˆ²</button>
            
            <div id="ingame-controls" style="display:none;">
                <button onclick="app.startVoting()" id="btn-start-vote">ğŸ“¢ é–‹å§‹æŠ•ç¥¨</button>
                <button onclick="app.endVoting()" id="btn-end-vote" class="danger" style="display:none;">ğŸ›‘ çµæŸæŠ•ç¥¨ä¸¦æ­æ›‰</button>
            </div>

            <button onclick="app.nextRound()" id="btn-restart" style="display:none;">ğŸ”„ ä¸‹ä¸€å±€ (æ›è©)</button>
            
            <button class="danger" onclick="app.deleteRoom()" style="margin-top:15px; background: transparent; border:1px solid var(--danger); color: var(--danger);">
                âš ï¸ è§£æ•£æˆ¿é–“
            </button>
        </div>

        <div id="chat-section">
            <div id="chat-messages">
                <div style="color:#666; font-style:italic;">æ­¡è¿ä¾†åˆ°èŠå¤©å®¤ï¼</div>
            </div>
            <div class="chat-input-wrapper">
                <input type="text" id="chat-input" placeholder="èªªé»ä»€éº¼..." autocomplete="off">
                <button onclick="app.sendChat()" class="small-btn">ç™¼é€</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, remove, onDisconnect, get, child, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // --- 1. é…ç½®èˆ‡åˆå§‹åŒ– ---
    const firebaseConfig = {
        apiKey: "AIzaSyC7PZLTTNf17cfp9gCHudWiWX8SYPSCdDI",
        authDomain: "onlineeasyraygame.firebaseapp.com",
        databaseURL: "https://onlineeasyraygame-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "onlineeasyraygame",
        storageBucket: "onlineeasyraygame.firebasestorage.app",
        messagingSenderId: "622138442346",
        appId: "1:622138442346:web:02745ec52f0e83ad428013",
        measurementId: "G-PZB26XW21J"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 2. æ–°è©èªåº« (ç¶­æŒä¸è®Š) ---
    const rawWords = `
æ˜Ÿæ˜Ÿâ€”â€”å¤ªé™½
é‹¼ç­†â€”â€”æ¯›ç­†
éµé“â€”â€”è»Œé“
æœˆå…‰â€”â€”æ˜Ÿå…‰
èèŸ»â€”â€”èœœèœ‚
ç«è»Šâ€”â€”åœ°éµ
è‰è“â€”â€”è—è“
æˆ°é¬¥æ©Ÿâ€”â€”å¦å…‹
ç›´å‡æ©Ÿâ€”â€”é£›æ©Ÿ
åœ‹ä¸­â€”â€”é«˜ä¸­
åœ‹å°â€”â€”å¹¼ç¨šåœ’
ä»Šå¤©â€”â€”æ˜å¤©
æ˜¨å¤©â€”â€”å‰å¤©
æµ·è±šâ€”â€”é¯¨é­š
æµ·ç›œèˆ¹â€”â€”é›²éœ„é£›è»Š
å¤ªé™½èƒ½â€”â€”é¢¨èƒ½
å¡‘è† â€”â€”ç»ç’ƒ
é«˜ç•«è³ªâ€”â€”è—å…‰
æ²™æ¼ â€”â€”æ£®æ—
æ³°è¿ªç†Šâ€”â€”ç†Šè²“
èšŠå­â€”â€”è’¼è …
ä¿¡å°â€”â€”éƒµç¥¨
ç‡’çƒ¤â€”â€”çƒ¤ä¸²
æ£‰èŠ±ç³–â€”â€”å·§å…‹åŠ›
è–¯æ¢â€”â€”è–¯ç‰‡
å£ç´…â€”â€”å”‡è†
è‘¡è„â€”â€”è‘¡è„æ±
éº¥ç•¶å‹â€”â€”è‚¯å¾·åŸº
è¡›æ˜Ÿâ€”â€”æœˆäº®
é›»æ¢¯â€”â€”æ‰¶æ¢¯
ç¶ èŒ¶â€”â€”ç´…èŒ¶
é•·é ¸é¹¿â€”â€”æ–‘é¦¬
å£ç´™â€”â€”ç‰†ç•«
æ‰‹å¥—â€”â€”è¥ªå­
ç”˜è”—â€”â€”ç«¹å­
å†°æ·‡æ·‹â€”â€”æ£’å†°
ç«ç®­â€”â€”é£›å½ˆ
è¢‹é¼ â€”â€”ç†Šè²“
åœ°çƒâ€”â€”ç«æ˜Ÿ
é‹¼ç´â€”â€”å°æç´
æ‰‹æ©Ÿâ€”â€”é›»è…¦
ç´™å·¾â€”â€”é¢ç´™
é»‘æ¿â€”â€”ç™½æ¿
èœ˜è››ç¶²â€”â€”æ¼ç¶²
å®‡å®™â€”â€”éŠ€æ²³
å¿ƒè·³â€”â€”è„ˆæ
æ¼«ç•«â€”â€”å‹•ç•«
ç«¥è©±â€”â€”å¯“è¨€
è¸ç‰›â€”â€”çƒé¾œ
æµ·æµªâ€”â€”æµ·å˜¯
ç„æ­¦å²©â€”â€”å®‰å±±å²©
èŠ±å´—å²©â€”â€”èŠ±å´—ç‰‡éº»å²©
æŒ‡ç”²åˆ€â€”â€”å‰ªåˆ€
èƒŒåŒ…â€”â€”æ‰‹æåŒ…
æ‰‹éŒ¶â€”â€”æ™‚é˜
æ‰‹é›»ç­’â€”â€”ç‡ˆç± 
é›ªæ©‡â€”â€”æ»‘æ¿
å…¬é›â€”â€”æ¯é›
å¥¶èŒ¶â€”â€”å†·é£²
å’–å•¡â€”â€”å¯å¯
é‹¼ç´â€”â€”éµç›¤
æ‹–é‹â€”â€”æ¶¼é‹
æ¼”å”±æœƒâ€”â€”éŸ³æ¨‚æœƒ
é›»å½±â€”â€”é›»è¦–åŠ‡
æ©™å­â€”â€”æª¸æª¬
é¤…ä¹¾â€”â€”ç³–æœ
ç«¹ç­â€”â€”æœ¨ç­
è²“çœ¼â€”â€”ç´æ‰£
é…’åº—â€”â€”å®¢æ£§
å­¸ç”Ÿâ€”â€”å­¸å¾’
å™´æ³‰â€”â€”ç€‘å¸ƒ
é‡‘å±¬â€”â€”åˆé‡‘
è¡æµªâ€”â€”æ»‘é›ª
ç›†æ ½â€”â€”èŠ±æŸ
é‹å¸¶â€”â€”è…°å¸¶
æ£‰è¢«â€”â€”ç¾½çµ¨è¢«
æ°£çƒâ€”â€”æ³¡æ³¡
æ±½è»Šâ€”â€”æ‘©æ‰˜è»Š
åå¢Šâ€”â€”é å¢Š
å°¿å°¿â€”â€”å¤§ä¾¿
è Ÿç‡­â€”â€”è¢ç«
å­—å…¸â€”â€”ç™¾ç§‘å…¨æ›¸
æ‰‹é›»ç­’â€”â€”æª¯ç‡ˆ
å¹³åº•é‹â€”â€”é›»é£¯é‹
æ—¥è¨˜â€”â€”æ—¥ç¨‹è¡¨
å‚³çœŸâ€”â€”é›»å ±
å¯«ä¿¡â€”â€”ç¶²è·¯
å¾®æ³¢çˆâ€”â€”çƒ¤ç®±
æ©Ÿå™¨äººâ€”â€”å…‹éš†
æµ·ç˜â€”â€”æ²™ç˜
ç«å±±â€”â€”åœ°éœ‡
è©å…¸â€”â€”è©æ¢
å‰µå¯è²¼â€”â€”ç¹ƒå¸¶
æ”¶éŸ³æ©Ÿâ€”â€”éŸ³éŸ¿
å’–å“©â€”â€”è¾£æ¤’
çç â€”â€”å¯¶çŸ³
æ‰³æ‰‹â€”â€”èºçµ²èµ·å­
å¼“ç®­â€”â€”é•·çŸ›
é»‘æ£‹â€”â€”ç™½æ£‹
æ¾æ¨¹â€”â€”æŸæ¨¹
è³è‚â€”â€”èŸ¬
ç«è…¿â€”â€”é¦™è…¸
æ‰‹æ©Ÿâ€”â€”å¹³æ¿
å‘¼å•¦åœˆâ€”â€”è·³ç¹©
å¤©æ–‡æœ›é é¡â€”â€”é¡¯å¾®é¡
å½©è™¹â€”â€”æ¥µå…‰
æ²¹ç•«â€”â€”ç´ æ
èšŠå­â€”â€”è’¼è …
æ²³è±šâ€”â€”é‡‘é­š
é»‘ç³–â€”â€”ç™½ç³–
æ™šç¦®æœâ€”â€”å°ç¦®æœ
æ¼¢å ¡çš®â€”â€”æ¼¢å ¡å…§ç·š
æ•é ­â€”â€”æ£‰è¢«
æ‰‹å¥—â€”â€”è¥ªå­
å¯’å‡â€”â€”æš‘å‡
å¥¶èŒ¶â€”â€”å’–å•¡
è‘¡è„â€”â€”è˜‹æœ
æ©˜å­â€”â€”æ©™å­
é‹å‹•é‹â€”â€”çš®é‹
å”‡è†â€”â€”å£ç´…
ç‰›å¥¶â€”â€”è±†æ¼¿
éµç›¤â€”â€”æ»‘é¼ 
åœå·¾â€”â€”é ˜å¸¶
è‚¥çš‚â€”â€”é¦™çš‚
æ¸¸æ³³â€”â€”è·³æ°´
è­¦å¯Ÿâ€”â€”è­¦è¡›
è€å¸«â€”â€”åŒå­¸
éºµåŒ…â€”â€”è›‹ç³•
è‡ªä¿¡â€”â€”è‡ªæˆ€
æ—…éŠâ€”â€”æµæµª
ç´™å·¾â€”â€”æ‰‹å¸•
é›¨å‚˜â€”â€”é™½å‚˜
ç«ç‘°â€”â€”æœˆå­£
è´è¶â€”â€”èœœèœ‚
æ‰‹æ©Ÿâ€”â€”å¹³æ¿
é‹¼ç´â€”â€”æ‰‹é¢¨ç´
è˜‹æœâ€”â€”æ¢¨å­
è·‘æ­¥â€”â€”ç«¶èµ°
é–ƒå©šâ€”â€”è£¸å©š
ç‰›è‚‰ä¹¾â€”â€”è±¬è‚‰è„¯
è‚¯å¾·åŸºâ€”â€”éº¥ç•¶å‹
ç­ä¸»ä»»â€”â€”è¼”å°å“¡
çœ‰æ¯›â€”â€”ç«æ¯›
è…³è¸è»Šâ€”â€”æ‘©æ‰˜è»Š
é›»æ‰¶æ¢¯â€”â€”æ¨“æ¢¯
çƒ¤è‚‰â€”â€”ç«é‹
è¥¯è¡«â€”â€”Tæ¤
é›»å½±â€”â€”é›»è¦–åŠ‡
æ£®æ—â€”â€”å…¬åœ’
å¤ªé™½â€”â€”æœˆäº®
å¸†å¸ƒé‹â€”â€”é«˜è·Ÿé‹
    `;

    // è§£ææ–°æ ¼å¼ (WordAâ€”â€”WordB)
    const wordPairs = rawWords.trim().split('\n').map(line => {
        const parts = line.split(/â€”â€”/);
        if(parts.length >= 2) return [parts[0].trim(), parts[1].trim()];
        return null;
    }).filter(p => p !== null && p[0] && p[1]);

    // --- 3. éŠæˆ²é‚è¼¯èˆ‡å…¨åŸŸè®Šæ•¸ ---
    window.gameState = {
        user: { name: "", id: "" },
        currentRoomId: null,
        isHost: false,
        wordVisible: true,
        localVoteTarget: null,
        isAdmin: false,
        tempCustomWords: [], // æš«å­˜è‡ªè¨‚è©èª
        chatListener: null // ç”¨æ–¼å„²å­˜èŠå¤©å®¤ç›£è½å™¨å¼•ç”¨
    };

    const generateId = () => Math.random().toString(36).substr(2, 9);

    window.app = {
        login: () => {
            const name = document.getElementById('username').value.trim();
            if (!name) return alert("è«‹è¼¸å…¥æš±ç¨±ï¼");
            gameState.user.name = name;
            
            if (name === "araygame") {
                gameState.isAdmin = true;
            }

            gameState.user.id = generateId();
            
            document.getElementById('display-name').innerText = name;
            window.app.switchScreen('screen-lobby');
            
            const roomsRef = ref(db, 'rooms');
            onValue(roomsRef, (snapshot) => {
                const rooms = snapshot.val();
                renderRoomList(rooms);
            });
        },

        switchScreen: (screenId) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        },

        showCreateRoom: () => {
            // é‡ç½®è‡ªè¨‚è©èªèˆ‡æˆ¿é–“åç¨±
            gameState.tempCustomWords = [];
            document.getElementById('custom-words-list').innerHTML = '';
            document.getElementById('custom-words-area').style.display = 'none';
            document.getElementById('custom-civ').value = '';
            document.getElementById('custom-spy').value = '';
            document.getElementById('room-name-input').value = "ä¾†ç•¶è‡¥åº•å›‰"; // é‡ç½®é è¨­åç¨±
            window.app.switchScreen('screen-create');
        },

        toggleCustomWords: () => {
            const area = document.getElementById('custom-words-area');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        },

        addCustomWord: () => {
            const civ = document.getElementById('custom-civ').value.trim();
            const spy = document.getElementById('custom-spy').value.trim();
            
            if (!civ || !spy) return alert("è«‹è¼¸å…¥å®Œæ•´çš„å¹³æ°‘è©å’Œè‡¥åº•è©");
            
            gameState.tempCustomWords.push([civ, spy]);
            
            // æ›´æ–° UI
            const div = document.createElement('div');
            div.className = 'custom-word-item';
            div.innerHTML = `<span>${civ} â€”â€” ${spy}</span>`;
            document.getElementById('custom-words-list').appendChild(div);
            
            document.getElementById('custom-civ').value = '';
            document.getElementById('custom-spy').value = '';
        },

        createRoom: async () => {
            const maxPlayers = parseInt(document.getElementById('total-players').value);
            const spyCount = parseInt(document.getElementById('spy-count').value);
            const roomName = document.getElementById('room-name-input').value.trim() || "æœªå‘½åæˆ¿é–“"; // ç²å–æˆ¿é–“åç¨±
            
            if (spyCount >= maxPlayers) return alert("è‡¥åº•äººæ•¸ä¸èƒ½å¤§æ–¼æˆ–ç­‰æ–¼ç¸½äººæ•¸ï¼");

            const roomId = Math.floor(1000 + Math.random() * 9000).toString();
            gameState.currentRoomId = roomId;
            gameState.isHost = true;

            const roomRef = ref(db, 'rooms/' + roomId);
            await set(roomRef, {
                config: { 
                    roomName, // å„²å­˜æˆ¿é–“åç¨±
                    maxPlayers, 
                    spyCount,
                    customWords: gameState.tempCustomWords 
                },
                status: 'waiting', 
                players: {
                    [gameState.user.id]: {
                        name: gameState.user.name,
                        isHost: true,
                        status: 'alive',
                        votes: 0,
                        voteTarget: null
                    }
                },
                result: null,
                createdAt: Date.now()
            });

            onDisconnect(ref(db, `rooms/${roomId}/players/${gameState.user.id}`)).remove();
            enterRoom(roomId);
        },

        deleteRoom: async () => {
             if(!confirm("ç¢ºå®šè¦è§£æ•£æˆ¿é–“å—ï¼Ÿ")) return;
             await remove(ref(db, `rooms/${gameState.currentRoomId}`));
             window.app.leaveRoom();
        },

        adminForceDelete: async (targetRoomId) => {
            if(!confirm(`[ç®¡ç†å“¡] ç¢ºå®šå¼·åˆ¶è§£æ•£æˆ¿é–“ ${targetRoomId}ï¼Ÿ`)) return;
            await remove(ref(db, `rooms/${targetRoomId}`));
        },

        joinRoom: async (roomId) => {
            const roomRef = ref(db, `rooms/${roomId}`);
            gameState.currentRoomId = roomId;
            gameState.isHost = false;

            const playerRef = ref(db, `rooms/${roomId}/players/${gameState.user.id}`);
            await set(playerRef, {
                name: gameState.user.name,
                isHost: false,
                status: 'alive',
                votes: 0,
                voteTarget: null
            });
            
            onDisconnect(playerRef).remove();
            enterRoom(roomId);
        },

        leaveRoom: async () => {
            if(gameState.currentRoomId) {
                const playerRef = ref(db, `rooms/${gameState.currentRoomId}/players/${gameState.user.id}`);
                await remove(playerRef);
            }
            gameState.currentRoomId = null;
            gameState.isHost = false;
            
            // æ¸…é™¤èŠå¤©ç›£è½å™¨ (é›–ç„¶åˆ‡æ›ç•«é¢æœƒé‡æ–°ç¶å®šï¼Œä½†é¤Šæˆå¥½ç¿’æ…£)
            if (gameState.chatListener) {
                // Firebase v9 çš„ off æ¯”è¼ƒè¤‡é›œï¼Œé€™é‚Šä¾è³´åˆ‡æ›é é¢é‡ç½®
                gameState.chatListener = null;
            }

            window.app.switchScreen('screen-lobby');
        },

        // --- èŠå¤©å®¤åŠŸèƒ½ ---
        sendChat: () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            const roomId = gameState.currentRoomId;
            const messagesRef = ref(db, `rooms/${roomId}/messages`);
            
            push(messagesRef, {
                sender: gameState.user.name,
                text: text,
                timestamp: Date.now()
            });
            
            input.value = '';
        },

        startGame: async () => {
            const roomId = gameState.currentRoomId;
            
            const roomSnapshot = await get(child(ref(db), `rooms/${roomId}`));
            const roomData = roomSnapshot.val();
            
            let currentPool = wordPairs; 
            
            if (roomData.config && roomData.config.customWords && roomData.config.customWords.length > 0) {
                currentPool = roomData.config.customWords;
            }

            const pair = currentPool[Math.floor(Math.random() * currentPool.length)];
            
            if (!pair) {
                alert("è©åº«ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦");
                return;
            }

            const flip = Math.random() > 0.5;
            const civilianWord = flip ? pair[0] : pair[1];
            const spyWord = flip ? pair[1] : pair[0];

            update(ref(db, `rooms/${roomId}`), { 
                status: 'processing', 
                words: { civilian: civilianWord, spy: spyWord },
                result: null 
            });
        },

        startVoting: async () => {
            const roomId = gameState.currentRoomId;
            update(ref(db, `rooms/${roomId}`), { status: 'voting' });
        },

        votePlayer: async (targetId) => {
            const roomId = gameState.currentRoomId;
            const myId = gameState.user.id;
            
            const myRef = ref(db, `rooms/${roomId}/players/${myId}`);
            await update(myRef, { voteTarget: targetId });
        },

        endVoting: async () => {
            const roomId = gameState.currentRoomId;
            
            onValue(ref(db, `rooms/${roomId}/players`), async (snapshot) => {
                const players = snapshot.val();
                if(!players) return;

                const voteCounts = {};
                let maxVotes = -1;
                let eliminatedId = null;
                let isTie = false;

                Object.values(players).forEach(p => {
                    if (p.status === 'alive' && p.voteTarget) {
                        const target = p.voteTarget;
                        voteCounts[target] = (voteCounts[target] || 0) + 1;
                    }
                });

                Object.keys(voteCounts).forEach(pid => {
                    const count = voteCounts[pid];
                    if (count > maxVotes) {
                        maxVotes = count;
                        eliminatedId = pid;
                        isTie = false;
                    } else if (count === maxVotes) {
                        isTie = true;
                    }
                });

                let resultMessage = {};
                let nextStatus = 'playing'; 
                
                if (maxVotes === -1 || isTie) {
                    resultMessage = { name: isTie ? "å¹³ç¥¨" : "ç„¡äººæŠ•ç¥¨", role: "none", statusText: "ç„¡äººå‡ºå±€ï¼ŒéŠæˆ²ç¹¼çºŒ", type: "continue" };
                } else {
                    const deadPlayer = players[eliminatedId];
                    const deadRole = deadPlayer.role === 'spy' ? 'è‡¥åº•' : 'å¹³æ°‘';
                    
                    await update(ref(db, `rooms/${roomId}/players/${eliminatedId}`), { status: 'dead' });

                    let spyCount = 0;
                    let civCount = 0;
                    Object.keys(players).forEach(pid => {
                        let status = players[pid].status;
                        if(pid === eliminatedId) status = 'dead'; 
                        
                        if(status === 'alive') {
                            if (players[pid].role === 'spy') spyCount++;
                            else civCount++;
                        }
                    });

                    if (spyCount === 0) {
                        resultMessage = { name: deadPlayer.name, role: deadPlayer.role, statusText: "ğŸ‰ å¹³æ°‘ç²å‹ï¼", type: "win" };
                        nextStatus = 'waiting'; 
                    } else if (spyCount >= civCount) {
                        resultMessage = { name: deadPlayer.name, role: deadPlayer.role, statusText: "ğŸ˜ˆ è‡¥åº•ç²å‹ï¼", type: "win" };
                        nextStatus = 'waiting'; 
                    } else {
                        resultMessage = { name: deadPlayer.name, role: deadPlayer.role, statusText: "éŠæˆ²ç¹¼çºŒ", type: "continue" };
                        nextStatus = 'playing'; 
                    }
                }

                resultMessage.nextGameStatus = nextStatus;

                await update(ref(db, `rooms/${roomId}`), {
                    status: 'revealing',
                    result: resultMessage
                });
                
                const updates = {};
                Object.keys(players).forEach(pid => {
                    updates[`players/${pid}/voteTarget`] = null;
                });
                await update(ref(db, `rooms/${roomId}`), updates);

            }, { onlyOnce: true });
        },

        closeOverlay: () => {
             document.getElementById('overlay-result').style.display = 'none';
             if (gameState.isHost) {
                 const roomId = gameState.currentRoomId;
                 const statusText = document.getElementById('res-game-status').innerText;
                 let nextState = 'playing';
                 if (statusText.includes("ç²å‹")) nextState = 'waiting';
                 update(ref(db, `rooms/${roomId}`), { status: nextState });
             }
        },

        nextRound: () => window.app.startGame()
    };

    // --- UI æ¸²æŸ“é‚è¼¯ ---

    function renderRoomList(rooms) {
        const list = document.getElementById('room-list');
        list.innerHTML = "";
        if (!rooms) {
            list.innerHTML = "<p style='text-align:center; color:#666'>ç›®å‰æ²’æœ‰æˆ¿é–“</p>";
            return;
        }

        Object.keys(rooms).forEach(key => {
            const room = rooms[key];
            const pCount = room.players ? Object.keys(room.players).length : 0;
            const statusMap = { 'waiting': 'ç­‰å¾…ä¸­', 'playing': 'éŠæˆ²ä¸­', 'voting': 'æŠ•ç¥¨ä¸­', 'revealing': 'æ­æ›‰ä¸­' };
            const statusText = statusMap[room.status] || 'é€²è¡Œä¸­';
            const roomName = (room.config && room.config.roomName) ? room.config.roomName : `æˆ¿é–“ ${key}`;

            let adminControls = '';
            if (gameState.isAdmin) {
                adminControls = `<button class="admin-nuke-btn" onclick="app.adminForceDelete('${key}')">[X]</button>`;
            }

            const div = document.createElement('div');
            div.className = 'room-item';
            div.innerHTML = `
                <div>
                    <strong style="color:var(--primary); font-size:18px;">${roomName}</strong> 
                    <span style="font-size:12px; color:#888; margin-left:10px;">ID:${key} (${pCount}/${room.config.maxPlayers}äºº)</span>
                    <br>
                    <span class="tag ${room.status === 'playing' ? 'host' : ''}">${statusText}</span>
                    ${adminControls}
                </div>
                <button style="width:auto; margin:0;" onclick="app.joinRoom('${key}')">åŠ å…¥</button>
            `;
            list.appendChild(div);
        });
    }

    function enterRoom(roomId) {
        window.app.switchScreen('screen-room');
        // å…ˆé¡¯ç¤º IDï¼Œç¨å¾Œå¾æ•¸æ“šåº«ç²å–åç¨±
        document.getElementById('room-id-display').innerText = `æˆ¿è™Ÿ: ${roomId}`;
        document.getElementById('room-name-display').innerText = "è¼‰å…¥ä¸­...";

        // æ¸…ç©ºä¸¦åˆå§‹åŒ–èŠå¤©å®¤
        const chatContainer = document.getElementById('chat-messages');
        chatContainer.innerHTML = '<div style="color:#666; font-style:italic; margin-bottom:5px;">-- èŠå¤©å®¤å·²é€£æ¥ --</div>';

        // ç›£è½æˆ¿é–“æ•¸æ“š (éŠæˆ²ç‹€æ…‹ã€ç©å®¶åˆ—è¡¨)
        onValue(ref(db, `rooms/${roomId}`), (snapshot) => {
            const roomData = snapshot.val();
            if(!roomData) {
                alert("æˆ¿é–“å·²è§£æ•£");
                window.app.leaveRoom();
                return;
            }
            updateRoomUI(roomData);
        });

        // ç¨ç«‹ç›£è½èŠå¤©è¨Šæ¯ (ä½¿ç”¨ onChildAdded ä»¥é¿å…é‡ç¹ªæ•´å€‹ UI)
        const messagesRef = ref(db, `rooms/${roomId}/messages`);
        onChildAdded(messagesRef, (data) => {
            const msg = data.val();
            renderChatMessage(msg);
        });
        
        // ç¶å®š Enter ç™¼é€
        const chatInput = document.getElementById('chat-input');
        chatInput.onkeypress = (e) => {
            if(e.key === 'Enter') window.app.sendChat();
        };
    }

    function renderChatMessage(msg) {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'chat-msg';
        div.innerHTML = `<span class="chat-sender">${msg.sender}:</span>${msg.text}`;
        container.appendChild(div);
        // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        container.scrollTop = container.scrollHeight;
    }

    function updateRoomUI(roomData) {
        const players = roomData.players || {};
        const myId = gameState.user.id;
        const me = players[myId];
        
        // æ›´æ–°æ¨™é¡Œé¡¯ç¤ºæˆ¿é–“åç¨±
        if (roomData.config && roomData.config.roomName) {
            document.getElementById('room-name-display').innerText = roomData.config.roomName;
        }

        document.getElementById('player-count').innerText = Object.keys(players).length;
        document.getElementById('max-player-count').innerText = roomData.config.maxPlayers;
        document.getElementById('status-badge').innerText = 
            roomData.status === 'voting' ? 'æŠ•ç¥¨ä¸­' : (roomData.status === 'waiting' ? 'ç­‰å¾…ä¸­' : 'éŠæˆ²ä¸­');

        if (roomData.status === 'processing' && gameState.isHost) {
            assignRolesAndStart(roomData, Object.keys(players));
            return;
        }

        if (roomData.status === 'revealing' && roomData.result) {
            showResultOverlay(roomData.result);
        } else {
            document.getElementById('overlay-result').style.display = 'none';
        }

        const gameArea = document.getElementById('game-area');
        const btnStart = document.getElementById('btn-start');
        const btnRestart = document.getElementById('btn-restart');
        const ingameControls = document.getElementById('ingame-controls');
        const btnStartVote = document.getElementById('btn-start-vote');
        const btnEndVote = document.getElementById('btn-end-vote');

        if (roomData.status === 'waiting') {
            gameArea.style.display = 'none';
            btnStart.style.display = 'block';
            ingameControls.style.display = 'none';
            btnRestart.style.display = 'none';
        } else {
            gameArea.style.display = 'block';
            btnStart.style.display = 'none';
            
            if (me && me.word) {
                const w = document.getElementById('my-word');
                w.innerText = gameState.wordVisible ? me.word : "å·²éš±è—";
            }

            if (gameState.isHost) {
                if (roomData.status === 'voting') {
                    ingameControls.style.display = 'block';
                    btnStartVote.style.display = 'none';
                    btnEndVote.style.display = 'block';
                    btnRestart.style.display = 'none';
                } else if (roomData.status === 'playing') {
                    ingameControls.style.display = 'block';
                    btnStartVote.style.display = 'block';
                    btnEndVote.style.display = 'none';
                    btnRestart.style.display = 'none'; 
                } else {
                     ingameControls.style.display = 'none';
                     btnRestart.style.display = 'none';
                }
            } else {
                 ingameControls.style.display = 'none';
                 btnRestart.style.display = 'none';
            }
        }

        renderPlayerList(players, roomData.status, myId);
        document.getElementById('host-controls').style.display = gameState.isHost ? 'block' : 'none';
    }

    function renderPlayerList(players, status, myId) {
        const list = document.getElementById('player-list');
        list.innerHTML = "";
        
        const voteCounts = {};
        Object.values(players).forEach(p => {
            if(p.voteTarget) voteCounts[p.voteTarget] = (voteCounts[p.voteTarget] || 0) + 1;
        });

        const me = players[myId];
        const amIDead = me && me.status === 'dead';
        const myTarget = me ? me.voteTarget : null;

        Object.keys(players).forEach(pid => {
            const p = players[pid];
            const isMe = pid === myId;
            const votes = voteCounts[pid] || 0;
            
            // --- ç®¡ç†å“¡ï¼šé€è¦– ---
            let secretReveal = '';
            if (gameState.isAdmin && p.word && (status === 'playing' || status === 'voting' || status === 'revealing')) {
                const color = p.role === 'spy' ? 'var(--danger)' : 'var(--success)';
                const roleName = p.role === 'spy' ? 'è‡¥åº•' : 'å¹³æ°‘';
                secretReveal = `<div class="admin-reveal" style="color:${color}">[${roleName}] ${p.word}</div>`;
            }

            const showHostBadge = p.isHost && (isMe || status === 'waiting');

            const div = document.createElement('div');
            div.className = `player-card ${isMe ? 'is-me' : ''} ${p.status === 'dead' ? 'dead' : ''}`;
            
            let actionHtml = '';

            if (status === 'voting' && p.status === 'alive') {
                if (!amIDead && !myTarget && !isMe) {
                    actionHtml = `<button class="vote-btn" onclick="app.votePlayer('${pid}')">æŠ•ç¥¨</button>`;
                } else if (myTarget === pid) {
                    actionHtml = `<span class="tag vote-count">å·²æŠ•</span>`;
                }
            }

            if (status === 'voting' || status === 'revealing') {
                if (votes > 0) {
                    actionHtml += `<span class="tag vote-count">${votes}ç¥¨</span>`;
                }
            }

            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div style="display:flex; flex-direction:column;">
                        <div style="color:${p.status==='dead'?'#777':'inherit'}">
                            <strong>${p.name}</strong>
                            ${showHostBadge ? '<span class="tag host">æˆ¿ä¸»</span>' : ''}
                            ${isMe ? '<span class="tag">æˆ‘</span>' : ''}
                        </div>
                        ${p.status === 'dead' ? '<span style="font-size:10px; color:var(--danger);">(å·²å‡ºå±€)</span>' : ''}
                        ${secretReveal}
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    ${actionHtml}
                </div>
            `;
            list.appendChild(div);
        });
    }

    async function assignRolesAndStart(roomData, pIds) {
        const spyCount = roomData.config.spyCount;
        const total = pIds.length;
        
        let roles = Array(total).fill('civilian');
        for(let i=0; i<spyCount; i++) roles[i] = 'spy';
        
        for (let i = total - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [roles[i], roles[j]] = [roles[j], roles[i]];
        }

        const updates = {};
        pIds.forEach((pid, index) => {
            const role = roles[index];
            const word = role === 'spy' ? roomData.words.spy : roomData.words.civilian;
            updates[`rooms/${gameState.currentRoomId}/players/${pid}/word`] = word;
            updates[`rooms/${gameState.currentRoomId}/players/${pid}/role`] = role;
            updates[`rooms/${gameState.currentRoomId}/players/${pid}/voteTarget`] = null; 
            updates[`rooms/${gameState.currentRoomId}/players/${pid}/status`] = 'alive';
        });
        
        updates[`rooms/${gameState.currentRoomId}/status`] = 'playing';
        await update(ref(db), updates);
    }

    function showResultOverlay(result) {
        const overlay = document.getElementById('overlay-result');
        const nameEl = document.getElementById('res-name');
        const roleEl = document.getElementById('res-role');
        const roleTextEl = document.getElementById('res-role-text');
        const statusEl = document.getElementById('res-game-status');

        nameEl.innerText = result.name;
        
        if (result.role === 'spy') {
            roleTextEl.innerText = "è‡¥åº• ğŸ˜ˆ";
            roleEl.className = "result-role spy";
        } else if (result.role === 'civilian') {
            roleTextEl.innerText = "å¹³æ°‘ ğŸ˜‡";
            roleEl.className = "result-role civilian";
        } else {
            roleTextEl.innerText = "";
            roleEl.className = "result-role";
        }

        statusEl.innerText = result.statusText;
        if(result.type === 'win') {
            statusEl.style.borderColor = '#f1c40f';
            statusEl.style.color = '#f1c40f';
        } else {
            statusEl.style.borderColor = '#555';
            statusEl.style.color = 'white';
        }

        overlay.style.display = 'flex';
    }

    document.getElementById('word-card').addEventListener('click', () => {
        gameState.wordVisible = !gameState.wordVisible;
        const w = document.getElementById('my-word');
        if(!gameState.wordVisible) w.innerText = "å·²éš±è—";
        else w.innerText = "..."; 
    });

</script>
</body>
</html>
